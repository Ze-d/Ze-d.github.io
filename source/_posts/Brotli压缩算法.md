---
title: Brotli压缩算法
date: 2025-12-15 20:32:17
tags: Algorithm
---

下面把 **Brotli（BR）算法**拆开讲清楚：它到底由哪些“积木”组成、编码流长什么样、为什么在 Web 文本上往往比 gzip 更小；然后再和几类常见压缩算法做对比。

------

## 1) Brotli 的整体框架：LZ77 + Huffman + 上下文建模 + 静态字典

Brotli 本质上是一个“混合体”：

1. **LZ77（后向引用）**：用“复制指令”引用前面已经出现过的字节串（滑动窗口/环形缓冲区）。
2. **熵编码（Huffman）**：把“字面量、长度、距离、指令”等符号用变长码压缩。
3. **上下文建模（context modeling）**：对 *字面量*（literal）不一视同仁，而是根据“前面几个字节/是否在单词里”等上下文选择不同的 Huffman 码表，提高压缩率。
4. **内置静态字典（≈120KB）+ 变换规则**：专门为 Web 常见词片段准备（比如常见子串、后缀、HTML/CSS/JS 里常见片段），并支持大小写/前后缀等“变换”，能把很多字符串用“引用字典条目 + 变换”表示。

> 这四点叠加，就是 Brotli 对 **文本类资源（HTML/CSS/JS/JSON/SVG）**特别强的原因。

------

## 2) Brotli 编码流长啥样：按 Meta-block 分段

Brotli 把输入切成多个 **meta-block**（可以理解为“大块”）：

- 每个 meta-block 要么是 **未压缩块**（直接原样放进去，适合已经不可压缩的数据或很小片段）
- 要么是 **压缩块**（核心内容在这里）

压缩块内部不是“单一码表一路到底”，而是把符号分成三条（近似）并行的“通道”，分别建模：

- **Literal（字面量）通道**：插入的原始字节
- **Command（指令）通道**：描述“插入多少字面量 + 复制多少 + 用哪个距离/字典项”
- **Distance（距离）通道**：复制操作的回溯距离（或字典引用相关参数）

而且每个通道还能进一步分成 **block types**（块类型），即在一个 meta-block 内可以切换多套 Huffman 表：
“这段像英文文本 → 用一套表”，“下一段像 JSON 结构符号多 → 换一套表”。这对“混合内容”（比如 HTML 里夹 JS/CSS/数据）非常有利。

------

## 3) 核心指令模型：Insert/Copy（以及 Copy-from-dictionary）

Brotli 的数据重建过程可以理解为不断执行 **命令序列**：

### 3.1 Insert（插入字面量）

命令里带一个 `insert_length`：表示接下来要从 literal 流里取多少个原始字节输出。

### 3.2 Copy（从窗口复制）

命令里带一个 `copy_length` 和一个距离 `distance`：
从已输出的数据里“向后看 distance 个字节”，复制 `copy_length` 个字节出来。

Brotli 还有一个常见优化：**距离缓存（distance cache）**
会记住最近用过的几个距离（比如最近 4 个），下一次如果又出现相似距离，只需用很短的码表示“复用第 k 个最近距离”，对重复模式（HTML 标签、缩进、JSON 结构）很有效。

### 3.3 Copy-from-dictionary（静态字典引用）

除了从“已输出内容”回溯复制，Brotli 还可以直接引用 **内置字典的某个条目**，并施加变换（比如首字母大写、全大写、加前后缀等）。
这在 Web 场景里很吃香：大量“常见词根/后缀/协议字段名/路径片段”不必在数据里重复出现。

------

## 4) 为什么 Brotli 往往比 gzip 更小：两把“杀手锏”

### 4.1 更强的字面量上下文建模

gzip/deflate 的 literal Huffman 基本是“整块一套”，上下文能力弱。
Brotli 会根据上下文（前 1~2 个字节、是否在单词边界、位置特征等）选择不同的 Huffman 表，让“在某种上下文里更常见的字符”拥有更短码字。

### 4.2 静态字典 + 变换

gzip 没有内置字典（除非你用很少见的 preset dictionary 机制且客户端支持，Web 基本不用）。
Brotli 内置字典特别贴近 Web 文本，让很多字符串直接“引用字典”就能变得很短。

------

## 5) Brotli 和常见压缩算法对比（机制 & 取舍）

下面按“算法家族”对比，而不是只看一个指标。

### 5.1 Brotli vs gzip/deflate（Web 传统）

| 维度               | Brotli                                     | gzip/deflate                           |
| ------------------ | ------------------------------------------ | -------------------------------------- |
| 主要结构           | LZ77 + Huffman + **上下文** + **静态字典** | LZ77 + Huffman（上下文弱、无静态字典） |
| 典型压缩率（文本） | 通常更小                                   | 通常略大                               |
| 编码成本           | 等级高时更吃 CPU                           | 一般更省 CPU                           |
| 解码成本           | 通常可接受，浏览器支持好                   | 很成熟，普遍很快                       |
| 最佳用法           | Web 静态资源预压缩 `.br`                   | 兼容性兜底 / 动态压缩常用              |

结论：**面向浏览器发文本资源，Brotli 往往更优**；但动态压缩别开太高等级。

------

### 5.2 Brotli vs Zstandard（zstd）

zstd 的目标更偏“通用压缩/数据存储”，特点是 **压缩-解压速度/压缩率三者平衡非常强**，还支持 **训练字典**（对特定业务数据很猛）。

| 维度           | Brotli                             | zstd                                                         |
| -------------- | ---------------------------------- | ------------------------------------------------------------ |
| 核心           | LZ77 + Huffman + 上下文 + 静态字典 | LZ77 + 熵编码（常见实现用 Huffman + FSE 等）+ 可训练字典     |
| Web 浏览器原生 | **是**（Content-Encoding: br）     | 传统上不是“标准默认”，生态不如 br/gzip（取决于客户端/网关支持） |
| 场景强项       | HTTP 文本响应                      | 文件/日志/数据管道/存储、服务间传输                          |
| 性能取舍       | 高压缩等级编码成本高               | 低中等级非常快且压缩率不错                                   |

结论：**后端/数据存储/服务间**很多时候 zstd 更“工程甜点”；**浏览器响应压缩**通常 Brotli 更现实。

------

### 5.3 Brotli vs LZ4 / Snappy（极速低压缩）

这类算法追求 **极快的压缩与解压**，压缩率一般不如 Brotli/gzip/zstd。

| 维度   | Brotli           | LZ4/Snappy                     |
| ------ | ---------------- | ------------------------------ |
| 压缩率 | 更高             | 较低                           |
| CPU    | 编码可能较重     | 编码/解码都很轻                |
| 适用   | 面向公网带宽敏感 | 内网高吞吐、低延迟、CPU 更宝贵 |

结论：**带宽贵**用 Brotli；**CPU/延迟更敏感**用 LZ4/Snappy。

------

### 5.4 Brotli vs LZMA/xz（极限压缩）

LZMA（xz）倾向“压得最小”，但通常 **编码很慢**（并且内存/延迟成本更高）。

| 维度     | Brotli               | LZMA/xz                           |
| -------- | -------------------- | --------------------------------- |
| 压缩率   | 高（Web 文本很强）   | 往往更高（尤其离线归档）          |
| 编码速度 | 中等到慢（高等级慢） | 通常更慢                          |
| 典型用途 | HTTP 传输            | 离线包、归档、发布物（如 tar.xz） |

结论：**HTTP 在线压缩**通常不选 xz；它更像“打包发布/归档”。

------

### 5.5 Brotli vs bzip2（BWT 系）

bzip2 走 BWT（Burrows–Wheeler Transform）路线，压缩率比 gzip 好一些但速度与生态一般不如 zstd/brotli。

结论：现代工程里 bzip2 用得越来越少。

------

## 6) 工程选型一句话

- **浏览器响应压缩（HTML/CSS/JS/JSON）**：优先 **Brotli**，兼容回退 gzip
- **服务间/数据管道/存储**：优先考虑 **zstd**（特别是低中等级）
- **极低延迟高吞吐**：考虑 **LZ4/Snappy**
- **离线极限压缩归档**：**xz/LZMA**

