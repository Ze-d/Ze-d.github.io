---
title: Session and Cookie
date: 2025-08-21 10:43:34
tags: session cookie 计算机网络
---

**HTTP 协议本身是无状态的**。这意味着每一次客户端（浏览器）向服务器发出的请求都是独立的，服务器不会自动记住上一次请求是谁发来的。为了创建连续、个性化的用户体验（比如保持用户登录状态），就需要 Session 和 Cookie 来帮助服务器“记住”客户端。

---

### 一、Cookie

#### 1. 是什么？
Cookie 是一小段文本信息（通常最大为 4KB），由**服务器**通过 HTTP 响应的 `Set-Cookie` 头部发送给**客户端（浏览器）**。浏览器会将这些信息存储起来，并在后续对**同一域名的请求**中，通过 HTTP 请求的 `Cookie` 头部自动将其回传给服务器。

你可以把 Cookie 想象成服务器给浏览器的一张“会员卡”，上面记录了一些基本信息（如会员ID、偏好设置），浏览器每次访问这家“店”（服务器）时都会出示这张卡。

#### 2. 工作原理
1.  **首次请求**：用户首次访问网站，浏览器发送请求，请求中没有 Cookie。
2.  **服务器响应**：服务器需要记录状态（比如用户选择了语言偏好），于是在响应头中加入 `Set-Cookie: key=value`。
3.  **浏览器存储**：浏览器收到响应后，会将这个 Cookie 保存在本地（内存或硬盘上）。
4.  **后续请求**：此后，浏览器向**该域名下的任何路径**发送请求时，都会自动在请求头中带上 `Cookie: key=value`。
5.  **服务器读取**：服务器收到带有 Cookie 的请求，就能识别出这是哪个用户，从而提供个性化的内容。

#### 3. 主要属性（可选项）
服务器在设置 Cookie 时可以指定一些属性来控制其行为：
*   **Expires/Max-Age**：设置 Cookie 的过期时间。如果不设置，Cookie 就是“会话 Cookie”，在浏览器关闭时会被清除。
*   **Domain**：指定哪些主机可以接收此 Cookie。例如，设置为 `.example.com`，则 `a.example.com` 和 `b.example.com` 都可以使用。
*   **Path**：指定 URL 路径，只有路径匹配时才会发送 Cookie。
*   **Secure**：此 Cookie 只能通过 **HTTPS** 协议加密传输。
*   **HttpOnly**：禁止 JavaScript 通过 `document.cookie` 访问此 Cookie，这是重要的**安全措施**，可以有效防止 XSS（跨站脚本）攻击窃取 Cookie。
*   **SameSite**：控制 Cookie 在跨站请求时是否被发送。这是防止 CSRF（跨站请求伪造）攻击的重要机制。
    *   `Strict`：完全禁止在跨站请求中发送 Cookie。
    *   `Lax`：宽松策略，允许部分安全的跨站请求（如导航链接）发送 Cookie。
    *   `None`：允许跨站发送，但必须同时设置 `Secure`（即必须使用 HTTPS）。

#### 4. 用途
*   会话管理（Session ID 通常就存储在 Cookie 中）
*   个性化设置（如主题、语言）
*   用户行为跟踪（分析工具）

---

### 二、Session

#### 1. 是什么？
Session（会话）是一种在**服务器端**存储用户相关数据的机制。由于 Cookie 存储在客户端且大小有限，不适合存储大量或敏感数据（如用户ID、购物车物品列表）。Session 解决了这个问题。

每个 Session 都有一个唯一的标识符，称为 **Session ID**。这个 Session ID 通常会通过 Cookie 发送给客户端保存。

你可以把 Session 想象成服务器后台的一个“保险柜”，而 Session ID 就是打开这个保险柜的“钥匙（存根）”。服务器把钥匙（Session ID）交给客户（通过 Cookie），客户下次来时出示钥匙，服务器就能找到对应的保险柜，取出里面的信息。

#### 2. 工作原理
1.  **首次请求**：客户端请求服务器。
2.  **创建 Session**：服务器为当前用户创建一个唯一的 Session ID，并在服务器上开辟一块存储空间（可以存在内存、数据库或缓存中）来保存用户数据（Session 数据）。
3.  **返回 Session ID**：服务器通过响应头的 `Set-Cookie`，将 Session ID 发送给浏览器。例如：`Set-Cookie: SESSIONID=abc123; HttpOnly`。
4.  **浏览器存储 ID**：浏览器将这个包含 Session ID 的 Cookie 保存起来。
5.  **后续请求**：浏览器每次请求都会自动带上这个包含 Session ID 的 Cookie。
6.  **服务器识别用户**：服务器收到请求后，解析出 Cookie 中的 Session ID，然后用这个 ID 去它的存储空间中查找对应的用户数据（Session 数据），从而知道请求来自哪个用户。

#### 3. 存储位置
Session 数据存储在服务器端，常见的位置有：
*   **服务器内存**：最快，但服务器重启或扩展时会丢失。
*   **分布式缓存**（如 Redis, Memcached）：推荐方式，性能好且适合集群部署。
*   **数据库**（如 MySQL）：可靠，但性能相比缓存稍差。

---

### 三、核心区别与关系

| 特性         | Cookie                                               | Session                                            |
| :----------- | :--------------------------------------------------- | :------------------------------------------------- |
| **存储位置** | **客户端**（浏览器）                                 | **服务器端**（内存、数据库、缓存）                 |
| **数据类型** | 只能是字符串                                         | 可以是任何数据结构（对象、数组等）                 |
| **安全性**   | **较低**，数据存储在客户端，可能被查看或篡改。       | **较高**，敏感数据存储在服务器，更安全。           |
| **性能影响** | 不直接影响服务器性能，但每次请求都会携带，增加带宽。 | 会增加服务器开销，因为需要查询和存储数据。         |
| **生命周期** | 可设置长期有效（通过 `Expires`）。                   | 通常有效时间较短（如用户 inactive 30分钟后过期）。 |
| **存储容量** | 很小（通常每个域名下最多4KB，且数量有限制）。        | 更大（受服务器资源限制，但远大于Cookie）。         |

#### 关系
它们不是二选一的关系，而是**协同工作**的关系，是最常见的组合方案：
1.  **Session 依赖于 Cookie**：Session 机制通常需要借助 Cookie 来传递 Session ID，从而将用户与服务器上的数据关联起来。
2.  **Cookie 是载体，Session 是内容**：Cookie（Session ID）是钥匙，Session 是保险箱里的宝物。

---

### 四、一个生动的例子：登录流程

1.  用户在登录页面输入用户名和密码，点击提交。
2.  浏览器将表单数据发送给服务器。
3.  服务器验证账号密码正确。
4.  服务器**创建 Session**，在存储空间（如 Redis）中生成一个记录 `{ sessionId: "abc123", userId: "1001", username: "alice" }`。
5.  服务器通过响应头 `Set-Cookie: SESSIONID=abc123; HttpOnly` 将 Session ID 发给浏览器。
6.  浏览器保存这个 Cookie。
7.  当用户访问个人主页时，浏览器的请求会自动带上 `Cookie: SESSIONID=abc123`。
8.  服务器收到请求，从 Cookie 中取出 `abc123`，并用它去 Redis 中查找，找到了用户 ID 是 `1001`。
9.  服务器知道这是用户 “alice”，于是从数据库取出 alice 的个人数据并返回给浏览器。
10. 用户看到自己的个人主页。

### 总结

*   **Cookie**：是客户端存储机制，用于保存一些小的、不敏感的数据，并由浏览器自动在每次请求中发送给服务器。它是实现状态记录的基础。
*   **Session**：是服务器端存储机制，用于保存用户的敏感或大量状态信息。它本身不网络传输，而是通过一个唯一的 **Session ID** 来标识。而这个 Session ID，绝大多数情况下，就是通过 **Cookie** 来在客户端和服务器之间传递的。

简单来说：**Cookie 让服务器认得浏览器，Session 让服务器认得浏览器背后的人。**
