---
title: CDN (内容分发网络) 架构与最佳实践
date: 2026-01-06 19:59:36
tags: cn
---

## 1. 概述 (Overview)

**CDN (Content Delivery Network)** 是一组分布在不同地理位置的服务器群。其核心目的是通过将内容缓存到离用户最近的网络边缘（Edge Nodes），来解决互联网网络拥塞状况，提高用户访问网站的响应速度。

### 核心价值

- **低延迟 (Low Latency):** 用户就近获取数据，物理距离缩短。
- **削峰填谷 (Offloading):** 承担绝大部分流量，保护源站（Origin Server）不被海量请求击垮。
- **安全性 (Security):** 隐藏源站真实 IP，提供 DDoS 防护和防盗链功能。

------

## 2. 工作原理 (Architecture)

CDN 的工作流程可以概括为“智能调度”与“缓存代理”。

### 2.1 请求流程

1. **DNS 解析:** 用户访问域名时，DNS 将请求指向最近的 CDN 节点（而非源站）。
2. **命中 (Cache Hit):** 边缘节点已有该资源缓存 -> 直接返回给用户 (速度极快)。
3. **未命中/回源 (Cache Miss):** 边缘节点没有该资源 -> 向**源站**发起请求 -> 获取资源 -> **缓存下来** -> 返回给用户。

------

## 3. 资源托管策略 (What to Cache)

并非所有数据都适合放入 CDN，需根据资源类型进行区分。

| **资源类型**  | **建议策略**     | **示例文件**                                   | **原因**                                                     |
| ------------- | ---------------- | ---------------------------------------------- | ------------------------------------------------------------ |
| **静态资源**  | ✅ **强烈推荐**   | `.jpg`, `.png`, `.css`, `.js`, `.woff`, `.mp4` | 内容固定，更新频率低，体积大，最消耗带宽。                   |
| **大文件**    | ✅ **强烈推荐**   | 安装包 (`.exe`, `.apk`), 压缩包 (`.zip`)       | 能够显著减少源站的带宽成本。                                 |
| **公共库**    | ✅ **推荐**       | jQuery, Bootstrap                              | 利用浏览器缓存，提升加载速度。                               |
| **动态 HTML** | ❌ **不推荐**     | `.jsp`, `.php`, 实时数据 Dashboard             | 内容随用户不同而变化，缓存会导致数据错误。                   |
| **敏感数据**  | ⚠️ **需特殊处理** | 用户合同, 身份证件                             | 需配合 URL 鉴权 (Token)，否则存在泄露风险。                  |
| **API 接口**  | ⚠️ **视情况而定** | `/api/v1/data`                                 | 通常由 API 网关处理。如果数据是公开且长时间不变的，可以配置 CDN。 |

------

## 4. 常见技术挑战与解决方案 (Pitfalls & Solutions)

引入 CDN 会增加架构复杂度，以下是开发中最常遇到的“坑”。

### 4.1 缓存一致性 (The "Old Code" Problem)

- **问题:** 源码更新了 JS/CSS 文件，但 CDN 节点还缓存着旧文件，导致用户看到页面错乱或旧 Bug。
- **解决方案:** **文件指纹 (Fingerprinting)**。
  - ❌ 不要用: `script.js` (覆盖式发布)
  - ✅ 要用: `script.a1b2c3.js` (Webpack/Vite 自动生成 hash)
  - *原理:* 文件名变了，CDN 视为新资源，强制回源拉取。

### 4.2 跨域资源共享 (CORS Issues)

- **问题:** 字体文件或 Canvas 图片加载失败，浏览器控制台报 `Access-Control-Allow-Origin` 错误。
- **解决方案:** 必须配置 HTTP 响应头允许跨域。
  - *Nginx/对象存储配置:* `Access-Control-Allow-Origin: *`

### 4.3 真实 IP 丢失 (Logging)

- **问题:** 后端日志显示所有请求都来自 CDN 节点的 IP，无法统计用户地域或做 IP 封禁。
- **解决方案:** 读取特定的 HTTP Header。
  - CDN 会在请求头中添加 `X-Forwarded-For` 或 `X-Real-IP`。
  - 应用代码应优先读取这些 Header，而非 Socket IP。

### 4.4 防盗链误杀 (The 403 Forbidden)

- **问题:** 开发环境 (`localhost`) 或 内部网络 (`Tailscale IP`) 无法加载 CDN 图片。
- **原因:** CDN 开启了 Referer 白名单校验，非白名单域名被拒绝。
- **解决方案:**
  - *临时:* 前端添加 `<meta name="referrer" content="no-referrer" />`。
  - *正规:* 在 CDN 控制台将调试域名加入白名单。

------

## 5. 部署检查清单 (Checklist)

在正式将 Docker 服务接入 CDN 前，请检查以下项：

1. [ ] **构建配置:** 前端打包工具是否启用了文件名 Hash (如 `app.8d7f.js`)？
2. [ ] **CORS 头:** 静态资源服务器是否返回了 `Access-Control-Allow-Origin`？
3. [ ] **回源 Host:** 确认 CDN 回源时 host 头配置正确（通常需与源站域名一致）。
4. [ ] **HTTPS 证书:** CDN 节点也需要配置 SSL 证书，否则 HTTPS 访问会报警。
5. [ ] **防盗链:** 确认 Referer 白名单是否包含了所有需要的域名（包括测试环境）。

------

## 6. 总结

CDN 是现代 Web 架构中不可或缺的基础设施。它通过空间换时间（分布式存储）解决了速度问题，通过中间层屏障解决了安全和压力问题。

**对于您目前的 Docker + Tailscale 架构：**

- **内部测试阶段:** 建议先不接 CDN，或在 CDN 设置宽松的 Referer 规则。
- **公网发布阶段:** 必须配置 CDN 以隐藏源站 IP，并开启严格的 Referer 防盗链以节省成本。
