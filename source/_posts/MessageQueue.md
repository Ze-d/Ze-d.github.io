---
title: MessageQueue
date: 2025-08-01 16:42:33
tags: [Java,MQ]
---

## 1. 消息队列（MQ）是什么

简单来说，**消息队列是一种用于在不同应用程序、服务或组件之间进行异步通信的中间件技术。** 它遵循“生产者-消费者”模型。 解耦发送者和接收者。发送者不需要知道接收者是谁、何时在线、处理能力如何；它只需要把消息发送到队列即可。接收者根据自己的处理能力，从队列中拉取消息进行处理。

## 2. 作用

1. **解耦：** **降低依赖性：** 使得生产者和消费者完全独立。生产者发送消息后即可返回，无需等待消费者处理完成。无论消费者是否在线，都不影响生产者发送消息。**提高系统灵活性：** 可以随意添加新的生产者或消费者，或者更改消费者的处理逻辑，而不会影响其他部分。
2. **异步：** **提高响应速度：** 无需等待消费者处理，可以立即返回结果。**降低阻塞：** 将非核心，耗时长的操作异步化，不阻塞主业务流程。
3. **削峰：**  应对高并发场景，消息队列作为缓冲区

## 3. 核心组件

1. Producer：
2. Broker：消息处理中心，负责消息的**存储，确认，重试**等，一般其中会包含多个queue
3. Consumer：

## 4. 工作原理

1. **消息：** 通信的基本单位，通常包含消息头（元数据，如ID、时间戳、路由键、优先级等）和消息体（实际负载数据，格式如JSON, XML, Protobuf等）。
2. **生产者：** 创建并发送消息到队列或主题的客户端。
3. **队列/主题：**
   - **队列：** 点对点模型的核心。消息被发送到特定队列，多个消费者竞争消费，一条消息只会被一个消费者处理。
   - **主题：** 发布/订阅模型的核心。生产者发布消息到主题，订阅了该主题的所有消费者都会收到该消息的副本。通常配合“订阅”使用。
4. **消费者：** 从队列或订阅中接收并处理消息的客户端。
5. **Broker：** 消息队列服务的核心服务器，负责接收消息、存储消息、路由消息（根据规则将消息投递到正确的队列/订阅）、维护消息状态、将消息推送给消费者或等待消费者拉取。
6. **消息确认：** 消费者成功处理消息后，向Broker发送ACK。Broker收到ACK后才会将消息标记为已处理并从队列中删除（或在持久化场景中标记状态）。如果消费者未发送ACK或发送NACK（否定确认），Broker通常会尝试重新投递。
7. **持久化：** Broker将接收到的消息写入磁盘存储，确保服务重启后消息不丢失。
8. **传输协议：** 定义生产者和消费者如何与Broker通信的规范，常见的有：
   - **AMQP：** 高级消息队列协议（RabbitMQ主要使用）。
   - **MQTT：** 轻量级消息协议（物联网场景常用）。
   - **STOMP：** 简单文本协议。
   - **JMS：** Java消息服务API（规范，有多种实现如ActiveMQ, HornetQ）。
   - **Kafka Protocol：** Kafka自定义的高效二进制协议。
   - **HTTP/REST：** 部分MQ提供HTTP接口。

## 5. 选型

1. **RabbitMQ:**
   - **特点：** 成熟、稳定、开源、社区活跃、支持AMQP协议（也支持其他如STOMP, MQTT）。功能丰富（灵活的路由、消息确认、持久化、高可用集群、管理界面好）。
   - **场景：** 通用性强，适用于各种需要可靠消息传递的场景，尤其是对消息路由、可靠性要求高的业务系统。
2. **Apache Kafka:**
   - **特点：** 高吞吐量、低延迟、分布式、持久化、水平扩展性极佳。基于发布/订阅模型，按分区存储和顺序处理消息。消息保留时间长（可配置）。
   - **场景：** 大数据管道、流处理、日志收集、实时分析、事件溯源、需要极高吞吐量和海量数据存储的场景。
3. **Apache RocketMQ:**
   - **特点：** 阿里巴巴开源，高性能、高可靠、低延迟、分布式、支持海量消息堆积。结合了Kafka的高吞吐和传统MQ的事务和可靠消息特性。对分布式事务（最终一致性）有较好支持。
   - **场景：** 电商交易、金融支付、对消息顺序、事务消息、高可靠性要求极高的场景。在国内尤其流行。

## 6. 引入问题

1. 复杂度增加
2. 消息丢失风险
3. 消息重复消费
4. 消息顺序问题
5. 消息延迟
6. 数据一直
7. 运维成本

## 7. Q&A

### 如何防止消息丢失

### 如何保证消息不被重复消费

### 如何确保消息发送和消息接受

### 如何解决消息堆积问题
